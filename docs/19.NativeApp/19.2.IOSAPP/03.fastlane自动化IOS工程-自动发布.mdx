---
title: 03 fastlaneè‡ªåŠ¨åŒ–IOSå·¥ç¨‹(ä¸‰)-è‡ªåŠ¨å‘å¸ƒ
date: 2023-01-06 08:52
---

```mdx-code-block
import Img from '@site/src/components/Img/index';

```

## 1 ä»€ä¹ˆæ˜¯è‡ªåŠ¨å‘å¸ƒ? 

&emsp; å‰é¢çš„ç« èŠ‚ä¸­çš„`beta`æµç¨‹å°½ç®¡èƒ½æ‰§è¡Œï¼Œä½†æ˜¯ï¼Œåœ¨åŒæ­¥è¯ä¹¦çš„è¿‡ç¨‹ä¸­è¦æ±‚å¼€å‘éƒ½è¾“å…¥éªŒè¯ç åæ‰èƒ½è¿›è¡Œå‘å¸ƒã€‚è¿™æ ·ä¸€æ¥å°±ç®—ä¸ä¸Šæ˜¯å…¨è‡ªåŠ¨åŒ–äº†ã€‚æ‰€ä»¥æœ¬ç« èŠ‚å°±
çš„å†…å®¹å°±æ˜¯æ¥è§£å†³è¿™ä¸€é—®é¢˜ï¼Œè·³è¿‡å¼€å‘è‹¹æœçš„[2-factor authentication (2FA)](https://support.apple.com/en-us/HT204915), å®ç°å®Œå…¨è‡ªåŠ¨åŒ–ã€‚

<Img src="https://qiniu.wuchuheng.com/images/WX20230107-082950.png" align='center' />

## 2 å¦‚ä½•æ‰é¿å…**2-factor authentication (2FA)**éªŒè¯å‘¢?
è‹¹æœå¼€å‘å¹³å°ä¸Šæœ‰[App Store Connect API](https://developer.apple.com/documentation/appstoreconnectapi)è¿™ç§å¯¹å¤–å¼€æ”¾çš„apiï¼Œå¯ä»¥é€šè¿‡
å€Ÿç€å¼€å‘**api**æ¥é¿å…è¿™ç§é—®é¢˜ã€‚æ‰€ä»¥ä¸ºäº†è°ƒç”¨è¿™ä¸ª**API`ï¼Œ æˆ‘ä»¬éœ€è¦åœ¨å¼€å‘è€…å¹³å°ä¸Šç”Ÿæˆä¸€ä¸ªå¯†é’¥ï¼Œæ‰èƒ½é€šè¿‡è¿™ä¸ªå¯†é’¥æ¥è°ƒç”¨è¿™ä¸ª**API**.

## 3 è·å–App Store Connect APIå¯†é’¥å’Œç›¸å…³ä¿¡æ¯

åœ¨[App Store Connect API](https://appstoreconnect.apple.com/access/api)ï¼Œ è¿›è¡Œç”Ÿæˆ. ç„¶åæŠŠæ–‡ä»¶ä¸‹è½½ä¸‹æ¥ã€‚

<Img src="https://qiniu.wuchuheng.com/images/WX20230107-130328.png" align="center" />


## 4 ä¿®æ”¹ç›¸å…³é…ç½®
### 4.1 åˆ›å»º**fastlane/.env**
`.env`æ–‡ä»¶æ˜¯ç”¨äºä¿å­˜ä¸€äº›åœ¨`fastlane`å¯åŠ¨æ—¶å°±é»˜è®¤åŠ è½½çš„ç¯å¢ƒå˜é‡ã€‚ç”±äºå¯†é’¥ç­‰é…ç½®åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¸èƒ½è¢«æ³„æ¼ï¼Œæ‰€ä»¥é‡‡ç”¨`.env`æ–‡ä»¶å½¢å¼æ¥ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œ
ä¸”ä¼šè¢«`git`æ‰€å¿½ç•¥,æ¥ä¿è¯å®‰å…¨ã€‚

```bash title="fastlane/.env"
# app store connect api key. https://appstoreconnect.apple.com/access/api
APP_STORE_CONNECT_API_KEY_CONTENT="-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----"

# Identifies the issuer who created the authentication token. https://appstoreconnect.apple.com/access/api
APP_STORE_CONNECT_API_ISSUER_ID="..."

# The key of app store connect api. https://appstoreconnect.apple.com/access/api
APP_STORE_CONNECT_API_KEY_ID="..."
```

### 4.2 ä¿®æ”¹**fastlane/Fastfile**

```git title="fastlane/fastfile"
diff --git a/fastlane/Fastfile b/fastlane/Fastfile
index ab44af6..a9e5aab 100644
--- a/fastlane/Fastfile
+++ b/fastlane/Fastfile
@@ -15,11 +15,17 @@
 
 default_platform(:ios)
 
+# Load the App Store Connect API token to use in other fastlane tools and actions. https://docs.fastlane.tools/actions/app_store_connect_api_key/
+api_key = app_store_connect_api_key(
+    key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
+    issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
+    key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
+)
 
 desc "Download certificates from the git"
 lane :syncCertificates do
-    match(type: "appstore")
-    match(type: "development")
+    match(api_key: api_key, type: "appstore", readonly: true)
+    match(api_key: api_key, type: "development", readonly: true)
 end
 
 platform :ios do
..

```

## 5 åˆ é™¤æœ¬åœ°è¯ä¹¦å¹¶æ‰§è¡Œ**bata**æµç¨‹çœ‹çœ‹è¡Œä¸è¡Œ

### 5.1 å¦‚ä½•åˆ é™¤æœ¬åœ°è¯ä¹¦?

<Img src="https://qiniu.wuchuheng.com/images/WX20230107-134713.png" align="center" />

### 5.1 æ‰§è¡Œ**beta**æµç¨‹
```bash
$ fastlane syncCertificates # åŒæ­¥ä¸‹è¯ä¹¦
$ fastlane beta # æ‰§è¡Œæµç¨‹
[âœ”] ğŸš€ 
[13:29:08]: fastlane detected a Gemfile in the current directory
[13:29:08]: However, it seems like you didn't use `bundle exec`
[13:29:08]: To launch fastlane faster, please use
[13:29:08]: 
[13:29:08]: $ bundle exec fastlane beta
[13:29:08]: 
...
[13:32:00]: fastlane.tools finished successfully ğŸ‰
```
> ç»“æœæ˜¯æˆåŠŸçš„ï¼Œä¹Ÿæ²¡æœ‰å‡ºç°è¦2æ¬¡éªŒè¯çš„æƒ…å†µ

## 6 æœ¬æ¬¡æ”¹åŠ¨çš„ä»£ç 
```git title="æœ¬æ¬¡ä¿®æ”¹çš„æ–‡ä»¶"
diff --git a/.gitignore b/.gitignore
index 55a0685..10ed8c5 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,2 +1,5 @@
 *.zip
 *.ipa
+.idea
+fastlane/.env
+tmp
diff --git a/fastlane/Fastfile b/fastlane/Fastfile
index ab44af6..a9e5aab 100644
--- a/fastlane/Fastfile
+++ b/fastlane/Fastfile
@@ -15,11 +15,17 @@
 
 default_platform(:ios)
 
+# Load the App Store Connect API token to use in other fastlane tools and actions. https://docs.fastlane.tools/actions/app_store_connect_api_key/
+api_key = app_store_connect_api_key(
+    key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
+    issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
+    key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
+)
 
 desc "Download certificates from the git"
 lane :syncCertificates do
-    match(type: "appstore")
-    match(type: "development")
+    match(api_key: api_key, type: "appstore", readonly: true)
+    match(api_key: api_key, type: "development", readonly: true)
 end
 
 platform :ios do
diff --git a/fastlane/Matchfile b/fastlane/Matchfile
index c454c5d..05986fc 100644
--- a/fastlane/Matchfile
+++ b/fastlane/Matchfile
@@ -4,8 +4,8 @@ storage_mode("git")
 
 type("development") # The default type, can be: appstore, adhoc, enterprise or development
 
-# app_identifier(["tools.fastlane.app", "tools.fastlane.app2"])
-# username("user@fastlane.tools") # Your Apple Developer Portal username
+app_identifier(["com.wuchuheng"])
+username("root@wuchuheng.com") # Your Apple Developer Portal username
 
 # For all available options run `fastlane match --help`
 # Remove the # in the beginning of the line to enable the other options
```

``` bash 
$ git add -A   
$ git status 
On branch master
Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        modified:   .gitignore
        new file:   fastlane/.env.example
        modified:   fastlane/Fastfile
        modified:   fastlane/Matchfile
        modified:   fastlane/report.xml
        modified:   wuchuheng.xcodeproj/project.pbxproj

$ git commit -m 'feat: configure app-store-connect-api'
[master f6c0f8a] feat: configure app-store-connect-api
 6 files changed, 40 insertions(+), 13 deletions(-)
 create mode 100644 fastlane/.env.example
```

## 7 æ€»ç»“

æœ¬æ–‡çš„ç›®æ ‡æ˜¯è§£å†³ä¹‹å‰åœ¨åŒæ­¥è¯ä¹¦æ—¶é‡åˆ°çš„2æ¬¡éªŒè¯æ‰€å¯¼è‡´çš„ä¸èƒ½å…¨è‡ªåŠ¨åŒ–å®ç°æµç¨‹ã€‚ä¸ºæ­¤äº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡äº†**app store connect api**çš„å¯¹å¤–
æ¥å£æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
&emsp; é‚£ä¹ˆè§£å†³è¿™ä¸€é—®é¢˜åï¼Œå°†å¯¹åé¢çš„`CI/CD`çš„è‡ªåŠ¨åŒ–èµ·åˆ°äº†é“ºå¹³é“è·¯çš„ä½œç”¨ã€‚ 

## 8 æºä»£ç 

[Source](https://github.com/wuchuheng/com.wuchuheng.ios.helloWorld)

## 8 å‚è€ƒèµ„æ–™

* [ã€Šfastlane.app_store_connect_api_keyã€‹](https://docs.fastlane.tools/actions/app_store_connect_api_key/)
* [Flutter CI/CD with Github Actions & Fastlane - Part 2(IOS)](https://jaysavsani07.medium.com/flutter-ci-cd-with-github-actions-fastlane-part-2-ios-a4b281921d39)



