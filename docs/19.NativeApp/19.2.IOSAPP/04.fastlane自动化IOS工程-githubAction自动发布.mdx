---
title: 04 fastlaneè‡ªåŠ¨åŒ–IOSå·¥ç¨‹(å››)-githubActionè‡ªåŠ¨å‘å¸ƒ
date: 2023-01-07 14:40
tags:
 - CI/CD
 - "Github action"
---

```mdx-code-block
import Img from '@site/src/components/Img/index';

```


## 1 ä¸ºä»€ä¹ˆè¦ç”¨**Github Action**æ¥è¿›è¡Œè‡ªåŠ¨å‘å¸ƒ?è¿™ä¹ˆåšçš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ 

&emsp; å¦‚æœåœ¨äººçš„ä¸€ç”Ÿå½“ä¸­ï¼Œå¦‚æœæŠŠä¸€ä»¶äº‹åšä¸€éå®Œå…¨å¯ä»¥ï¼Œä½†å¦‚æœä¸€ä»¶äº‹è¦é‡å¤åšä¸”ä¸çŸ¥é“è¦åšå¤šå°‘æ•°æ¬¡æ‰èƒ½æŠŠäº‹ä»¶æ¨è¿›ã€‚é‚£ä¹ˆï¼Œåœ¨è¿™ç§ä¸çŸ¥é“è¿˜è¦é‡å¤å¤šå°‘æ¬¡çš„äº‹ï¼Œåœ¨æœªæ¥ï¼Œ
åœ¨å¯é¢„è§çš„æœªæ¥ï¼Œå¦‚æœè¿™ç§é‡å¤çš„äº‹ä¸èƒ½é€‚å¯è€Œæ­¢ï¼Œé‚£ä¹ˆåœ¨å°†æ¥å®ƒä¸€å®šä¼šæ¶ˆè€—äººå¤§é‡çš„æ—¶é—´ä¸ç²¾åŠ›ï¼Œä»è€Œè®©äººæœ¬è¯¥æŠŠç²¾åŠ›ä¸“æ³¨äºæ›´é‡è¦çš„äº‹æƒ…ä¹‹å‰å°±å·²ç»è¢«è¿™ç§æ— æ„çš„çš„äº‹ç¼ èº«æ¶ˆè€—ç²¾åŠ›ï¼Œ
ä»è€Œåœ¨æ¨è¿›é‡è¦çš„äº‹æƒ…ä¹‹å‰å°±å·²ç»è€—å…‰äº†ç²¾åŠ›ï¼Œä»è€Œç›´æ¥å¯¼è‡´äº‹ä»¶çš„å¤±è´¥ã€‚    
&emsp;  æ€»ç»“å°±æ˜¯: é‡å¤ä¸”æ— æ„æ„ä¹‰çš„ä¸èƒ½åœ¨å½“ä¸‹è§£å†³ï¼Œé‚£ä¹ˆå®ƒä¸€å®šä¼šåœ¨æœªæ¥æ‹–ä½äººå‰è¿›çš„è„šæ­¥ã€‚è¿™æ˜¯å€ºåŠ¡ï¼Œå¦‚æœå½“ä¸‹ä¸è§£å†³ï¼Œé‚£ä¹ˆåœ¨æœªæ¥å…‰æ˜¯æ—¶é—´åˆ©æ¯çš„æ”¯å‡ºï¼Œå°†æ˜¯ä¸€ç¬”
æ²‰é‡çš„ä»£ä»·ã€‚  
&emsp;  æ‰€ä»¥è¿™ç§è½¯ä»¶æ‰“åŒ…ã€æ„å»ºæˆ–å‘å¸ƒè¿™ç§åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ— æ•°æ¬¡é‡å¤çš„äº‹å¯ä»¥è¿›è¡Œä¸€æ¬¡ï¼Œä½†ä¸èƒ½æ°¸æ— æ­¢å¢ƒé‡å¤ä¸‹å»ã€‚ç°åœ¨ä¸è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨æœªæ¥ï¼Œå¿…ç„¶æˆä¸ºé˜»ç¢è‡ªå·±
å‰è¿›çš„éšœç¢å¹¶è®©è‡ªå·±ç–²äºå¥”å‘½ã€‚    
&emsp;  æ€»ç»“å°±æ˜¯ï¼šäººç”Ÿæœ‰é™ï¼Œè¿™ç§æ²¡å®Œæ²¡äº†é‡å¤çš„é—®é¢˜ï¼Œå¿…é¡»å°½æ—©å½»åº•æ ¹é™¤æ‰è¡Œã€‚    
&emsp;  è€Œé…ç½®å¥½**github action**çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚ é‚£ä¹ˆå¼€å‘è€…å°±æ˜¯ä¸“æ³¨äºä»£ç çš„ç›´æ¥é—®é¢˜ï¼Œç„¶åç„¶åè§£å†³å®Œé—®é¢˜å°±ç›´æ¥æäº¤ä»£ç å°±å¯ä»¥äº†ï¼Œè‡³äºï¼Œ æ‰“åŒ…ã€æµ‹è¯•ã€å‘å¸ƒ,ç­‰ç­‰è¿™äº›é‡å¤
ä¸”æ— èŠæ— æ„ä¹‰çš„äº‹å°±äº¤ç»™è‡ªåŠ¨åŒ–æµç¨‹æ¥å¤„ç†ï¼Œåœ¨è‡ªåŠ¨åŒ–æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œè‡ªå·±å®Œå…¨å¯ä»¥å»å€’æ¯æ°´ï¼Œæ´»åŠ¨æ´»åŠ¨èº«å­ï¼Œæ”¾æ¾ä¸‹ã€‚ å†å›æ¥çœ‹çœ‹è‡ªåŠ¨åŒ–æµç¨‹æ‰§è¡Œçš„ç»“æœã€‚å°±å¯ä»¥äº†ã€‚ 

## 2 é‚£ä¹ˆåœ¨github Actionå¤§æ¦‚æ˜¯å¦‚ä½•å®ç°iosåº”ç”¨å‘å¸ƒçš„?

1. æœ¬åœ°æäº¤ä»£ç ç„¶åè§¦å‘æ„å»ºæµå…ˆç¨‹
2. github è¿›è¡Œæ„å»ºè€Œè¿™ä¸ªæ„å»ºè¿‡ç¨‹åˆåˆ†ä¸ºå‡ ä¸ªå°æ­¥éª¤: 
   - 2.1. é…ç½®å¥½æ„å»ºç¯å¢ƒçš„ç¯å¢ƒå˜é‡ï¼Œç”¨äºfastlaneæ„å»ºæ—¶ä½¿ç”¨
   - 2.2  åŒæ­¥**certificates**å’Œ**profiles**
   - 2.3  **fastlane**æ‰“åŒ…**IOS**
   - 2.4  **fastlane**å‘å¸ƒåˆ°**testflight**
   - 2.5  ç„¶åå°±æå®šäº†

## 3 é…ç½®fastlaneç¯å¢ƒå˜é‡

> `fastlane`ä¼šé»˜è®¤è¯»å–`fastlane/.env`æ–‡ä»¶ä¸­çš„é…ç½®æˆä¸ºç¯å¢ƒå˜é‡ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸‹é¢ä¼šæ”¶é›†åˆ°æ‰€éœ€è¦çš„ç¯å¢ƒå˜é‡å‰å†™å…¥`fastlane/.env`æ–‡ä»¶ä¸­ã€‚

:::tip æç¤º
ç”±äº`fastlane/.env`çš„ç¯å¢ƒå˜é‡å¾ˆç§å¯†ï¼Œæ‰€ä»¥ä¸èƒ½å…¬å¼€å‡ºæ¥,å»ºè®®ä¸è¦åŠ å…¥åˆ°`git`ä¸­ï¼Œå¦‚åœ¨`.gitignore`è¿›è¡Œé…ç½®.
```bash title=".gitignore"
# ...
fastlane/.env
# ...
```
:::


### 3.1 GIT_AUTHORIZATION
<details>
    <summary>GIT_AUTHORIZATION (Githubçš„è®¿é—®token)</summary>

&emsp;ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªå‚æ•°æ˜¯ç”¨æ¥è®¿é—®ä¿å­˜**Certificates**å’Œ**Profiles**çš„åœ°æ–¹ã€‚åœ¨**Github Action**çš„æ„å»º**IOS APP**å‰éœ€è¦å…ˆåŒæ­¥**Certificates**
å’Œ**Profiles**ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦æœ‰æƒé™èƒ½è®¿é—®åˆ°è¿™ä¸ªä»“åº“ï¼Œè€Œ**GIT_AUTHORIZATION**æ­£æ˜¯å…è®¸è®¿é—®è¿™ä¸ªä»“åº“çš„**Token*ã€‚ é‚£ä¹ˆå¦‚ä½•è·å–åˆ°è¿™ä¸ª**Token`å‘¢?
&emsp; Github > Your Profile > Settings > Developer Settings > Tokens(classic)ã€‚å¦‚:

<Img src="storage:///images/WX20230108-093823.png" align="center"/>
</details>

### 3.2 APP_STORE_CONNECT_API...

<details>
    <summary> APP_STORE_CONNECT_API_KEY_CONTENT <br/> APP_STORE_CONNECT_API_ISSUER_ID <br/> APP_STORE_CONNECT_API_KEY_ID </summary>

&emsp; è¿™3ä¸ªå‚æ•°æ˜¯æ¥è‡ª [appstoreconnect.apple.com](https://appstoreconnect.apple.com/access/api)ã€‚
é‚£ä¹ˆè¿™ä¸ª3ä¸ªå‚æ•°è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ é€šè¿‡è¿™3ä¸ªå‚æ•°å°±èƒ½å¯¹æ¥åˆ°è‹¹æœçš„å¼€å‘è€…å¹³å°ï¼Œèƒ½åšåˆ°ï¼Œå¦‚: ä¸‹è½½è¯ä¹¦(**certificates**)ã€**profiles**å’Œä¸Šä¼ ç­¾ååº”ç”¨ç­‰æ“ä½œã€‚ 
è€Œæœ¬æ–‡å°±éœ€è¦é€šè¿‡è¿™äº›å‚æ•°æ¥å®ç°å¯¹åº”ç”¨åœ¨ç­¾åæ—¶è§„é¿2æ¬¡éªŒè¯([Two-factor authentication for Apple ID](https://support.apple.com/en-us/HT204915))å’Œåº”ç”¨çš„ä¸Šä¼ ã€‚
    
> ä½ç½®æ˜¯: Users and Access > Keys > Key Type > App Store Connect APIã€‚

<Img src="storage:///images/WX20230107-130328.png" />
</details>

### 3.3 APP_IDENTIFIER

<details>
    <summary>APP_IDENTIFIER (åº”ç”¨æ ‡è¯†)</summary>

    &emsp; åº”ç”¨æ ‡è¯†identifieræ˜¯è‹¹æœå¼€å‘è€…å¹³å°çš„åº”ç”¨æ ‡è¯†ï¼Œå¦‚æœä¸çŸ¥é“çš„è¯å¯ä»¥å»[developer.apple.com](https://developer.apple.com/account/resources/identifiers/list)
    æŸ¥çœ‹, åœ¨åˆ›å»ºå¼€å‘è€…å¹³å°åˆ›å»ºåº”ç”¨ä¹‹å‰å°±éœ€è¦å…ˆåˆ›å»º**identifier**, å®ƒçš„å‘½åé€šå¸¸æ˜¯ä»¥å€’ç½®åŸŸåæ¥å‘½åçš„

    > ä½ç½®:  [Certificates,Identifiers&Profiles](https://developer.apple.com/account/resources/identifiers/list) > Identifiers

    <Img src="storage:///images/WX20230110-133927.png" align="center" />

</details>

### 3.4 MATCH_PASSWORD

MATCH_PASSWORD (match å¯†ç ), ç”¨äºåŒæ­¥**git**ä¸Šè¯ä¹¦(certificates)å’Œ**Profilesåˆ°æœ¬åœ°ç”¨çš„ã€‚

### 3.5 TEMP_KEYCHAIN_USER
ç”¨äºåˆ›å»ºæœ¬åœ°`keychain`ä½¿ç”¨ï¼Œåç§°å¯ä»¥è‡ªå·±å®šä¹‰ã€‚

### 3.6 TEMP_KEYCHAIN_USER
ç”¨äºåˆ›å»ºæœ¬åœ°`keychain`ä½¿ç”¨ï¼Œåç§°å¯ä»¥è‡ªå·±å®šä¹‰ã€‚

### 3.7 FASTLANE_APPLE_ID
å¼€å‘è€…è€…è´¦å·

### 3.8 ITC_TEAM_ID
è¿™ä¸ªå‚æ•°çš„å‡ºå¤„æˆ‘è¿˜æ²¡æ‰¾åˆ°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯åˆå§‹åŒ–**fastlane**å·¥ç¨‹æ—¶ï¼Œè¾“å…¥è´¦å·å’Œå¯†ç æ—¶, è‡ªåŠ¨åœ¨`fastlane/Fastfile`ç”Ÿæˆçš„ã€‚ åº”ç”¨äº: itc_team_id(***), 
åé¢ä¸ºäº†å®‰å…¨ï¼ŒæŠŠå®ƒæ”¾äº†åœ¨`fastlane/.env`ä¸­, åˆ›å»ºäº†`ITC_TEAM_ID="<ITC_TEAM_ID>"`è¿™ä¸€ä¸ªç¯å¢ƒå˜é‡ã€‚å¹¶ç”¨åè¿‡æ›¿ä»£`itc_team_id(ENV["ITC_TEAM_ID"])`

### 3.9 DEVELOPER_PORTAL_TEAM_ID
å¼€å‘è€…å¹³å°çš„`Team ID`
> ä½ç½®:  [develope acciont](https://developer.apple.com/account) > Membership details > Team ID

### 4.0 GIT_AUTHORIZATION
**Github Token **ç”¨äºåœ¨ä½¿ç”¨`match`åŒæ­¥æœ¬åœ°è¯ä¹¦(certificates)å’ŒProfilesæ—¶ï¼Œèƒ½æœ‰æƒé™è®¿é—®åˆ°è¿™ä¸ªä»“åº“.

> ä½ç½®: [Github](https://github.com) > [Setting](https://github.com/settings/profile) > [Token](https://github.com/settings/tokens) > Generate token

### 4.1 æ±‡æ€»åçš„**fastlane/.env**é…ç½®

```bash title="fastlane/.env"
APP_STORE_CONNECT_API_KEY_CONTENT="-----BEGIN PRIVATE KEY-----
<APP_STORE_CONNECT_API_KEY_CONTENT>
-----END PRIVATE KEY-----"
# Identifies the issuer who created the authentication token. https://appstoreconnect.apple.com/access/api
APP_STORE_CONNECT_API_ISSUER_ID="<APP_STORE_CONNECT_API_ISSUER_ID>"
# The key of app store connect api. https://appstoreconnect.apple.com/access/api
APP_STORE_CONNECT_API_KEY_ID="<APP_STORE_CONNECT_API_KEY_ID>"

# APP IDENTIFIER, https://developer.apple.com/account/resources/identifiers/list
APP_IDENTIFIER="<APP_IDENTIFIER>"

# Fastlane match password
MATCH_PASSWORD="<MATCH_PASSWORD>"

# The name from keychain.
TEMP_KEYCHAIN_USER="<TEMP_KEYCHAIN_USER>"

# The IOS APP IDï¼Œ
FASTLANE_APPLE_ID="<FASTLANE_APPLE_ID>"

#App Store Connect Team ID, Used for itc_team_id in Appfile.
ITC_TEAM_ID="<ITC_TEAM_ID>"

#Developer Portal Team ID, Used for team_id in Appfile.
DEVELOPER_PORTAL_TEAM_ID="<DEVELOPER_PORTAL_TEAM_ID>"

# Github token to access repository for certificates.
GIT_AUTHORIZATION="<GIT_AUTHORIZATION>"
```

## 4 **fastlane/Matchfile**æ–‡ä»¶é…ç½®

```bash title="fastlane/Matchfile"
git_url("https://github.com/wuchuheng/certificates.git")

storage_mode("git")

type("development") # The default type, can be: appstore, adhoc, enterprise or development
```

## 5 **fastlane/Appfile**æ–‡ä»¶é…ç½®
```bash title="fastlane/Appfile"
app_identifier(ENV["APP_IDENTIFIER"]) # The bundle identifier of your app
apple_id(ENV["FASTLANE_APPLE_ID"]) # Your Apple Developer Portal username

itc_team_id(ENV["ITC_TEAM_ID"]) # App Store Connect Team ID
team_id(ENV["DEVELOPER_PORTAL_TEAM_ID"]) # Developer Portal Team ID
```

## 6 **fastlane/Fastfile**æ–‡ä»¶é…ç½®
```bash title="fastlane/Fastfile"
default_platform(:ios)

api_key = app_store_connect_api_key(
    key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
    issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
    key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
)

platform :ios do
    desc "Download certificates from the git"
    lane :syncCertificates do
        match(
            api_key: api_key,
            type: "appstore",
            git_basic_authorization: Base64.strict_encode64(ENV["GIT_AUTHORIZATION"]),
            keychain_password: ENV["MATCH_PASSWORD"]
         )
        match(
           api_key: api_key,
           type: "development",
           git_basic_authorization: Base64.strict_encode64(ENV["GIT_AUTHORIZATION"]),
           keychain_password: ENV["MATCH_PASSWORD"]
       )
    end
  desc "Push a new beta build to TestFlight"
  lane :beta do
   if ENV['CI']
        create_keychain(
            name: ENV["TEMP_KEYCHAIN_USER"],
            password: ENV["MATCH_PASSWORD"],
            default_keychain: true,
            unlock: true,
            timeout: 3600,
            lock_when_sleeps: false
        )

        match(
            keychain_name: ENV["TEMP_KEYCHAIN_USER"],
            api_key: api_key,
            type: "appstore",
            git_basic_authorization: Base64.strict_encode64(ENV["GIT_AUTHORIZATION"]),
            keychain_password: ENV["MATCH_PASSWORD"]
         )
    end
    increment_build_number({ build_number: latest_testflight_build_number + 1 })
    build_app( scheme: "wuchuheng", xcodebuild_formatter: "" )
    upload_to_testflight(skip_waiting_for_build_processing: true)
  end
end

```


## 7 æœ¬åœ°æµ‹è¯•fastlaneçš„å‘å¸ƒæµç¨‹èƒ½ä¸èƒ½æˆåŠŸ?
```bash title="æœ¬åœ°æµ‹è¯•èƒ½ä¸èƒ½å‘å¸ƒ"
$ fastlane syncCertificates #ä»gitåŒæ­¥è¯ä¹¦ä¸‹æ¥

[âœ”] ğŸš€ 
[15:01:18]: fastlane detected a Gemfile in the current directory
...
[15:01:31]: fastlane.tools finished successfully ğŸ‰

$ fastlane beta # å¯åŠ¨å‘å¸ƒæµç¨‹

[âœ”] ğŸš€ 
[15:03:29]: fastlane detected a Gemfile in the current directory
...
[15:04:38]: fastlane.tools finished successfully ğŸ‰

```

> ä»¥ä¸Š2æ­¥çš„éƒ½æ‰§è¡ŒæˆåŠŸå°±è¯´æ˜çš„åœ¨æœ¬åœ°çš„è¯ä¹¦(certificates) åŒæ­¥å’Œå‘å¸ƒè¿™2ä¸ªæµç¨‹æ˜¯æ²¡æœ‰é—®é¢˜çš„

## 8 Github action è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒ

### 8.1 é…ç½®Github actionçš„ç¯å¢ƒå˜é‡
ç”±äº`fastlane/.env`ä¸­è®°å½•çš„æ•°æ®å¾ˆç§å¯†ï¼Œæ‰€ä»¥è¿™ä¸ªæ–‡ä»¶ä¸èƒ½æäº¤åˆ°**git**ä¸Šï¼Œ æ‰€ä»¥æˆ‘ä»¬éœ€è¦çš„`fastlane/.env`çš„å˜é‡é…ç½®çš„`github acton`çš„**secrets**ä¸­ï¼Œ 
è®©å…¶æœ‰æ„å»ºçš„è¿‡ç¨‹ä¸­ï¼Œå‚ä¸è¿›å»ã€‚ é…ç½®æ–¹å¼å°±æ˜¯æŠŠæœ¬åœ°çš„`fastlane/.env`æ–‡ä»¶çš„é…ç½®åŠ å…¥åˆ°: repo(ä»“åº“) > Settings > Secrets > Actions > Repository secrets;

<Img src='/images/WX20230110-151411.png' align="center"/>

### 8.2 é…ç½®github action

```bash title=".github/workflows/deployment_ios.yml"
name: Appstore Deployment

on:
  push:
    tags:
      - v*

jobs:
  deploy_ios:
    name: Deploy build to TestFlight
    runs-on: macOS-latest
    steps:
      - name: Checkout code from ref
        uses: actions/checkout@v2
        with:
          ref: ${{ github.ref }}
      - name: Configure env
        run: |
          envFile="fastlane/.env";
          touch $envFile;
          cat >> $envFile  <<EOL
          GIT_AUTHORIZATION="${{ secrets.GIT_AUTHORIZATION }}"
          EOL
          cat >> $envFile  <<EOL
          APP_STORE_CONNECT_API_KEY_CONTENT="${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}"
          EOL
          cat >> $envFile  <<EOL
          APP_STORE_CONNECT_API_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}"
          EOL
          cat >> $envFile  <<EOL
          APP_STORE_CONNECT_API_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}"
          EOL
          cat >> $envFile  <<EOL
          APP_IDENTIFIER="${{ secrets.APP_IDENTIFIER }}"
          EOL
          cat >> $envFile  <<EOL
          MATCH_PASSWORD="${{ secrets.MATCH_PASSWORD }}"
          EOL
          cat >> $envFile  <<EOL
          TEMP_KEYCHAIN_USER="${{ secrets.TEMP_KEYCHAIN_USER }}"
          EOL
          cat >> $envFile  <<EOL
          FASTLANE_APPLE_ID="${{ secrets.FASTLANE_APPLE_ID }}"
          EOL
          cat >> $envFile  <<EOL
          ITC_TEAM_ID="${{ secrets.ITC_TEAM_ID }}"
          EOL
          cat >> $envFile  <<EOL
          DEVELOPER_PORTAL_TEAM_ID="${{ secrets.DEVELOPER_PORTAL_TEAM_ID }}"
          EOL
          cat >> $envFile  <<EOL
          GIT_AUTHORIZATION="${{ secrets.GIT_AUTHORIZATION }}"
          EOL
          cat $envFile
      - name: Sync Certificates.
        uses: maierj/fastlane-action@v1.4.0
        with:
          lane: syncCertificates
      - name: Deploy iOS Beta to TestFlight via Fastlane
        uses: maierj/fastlane-action@v1.4.0
        with:
          lane: beta
```
> è¿™æ–‡ä»¶åœ¨æ„æ€æ˜¯ï¼Œå½“æœ‰æ–°çš„ç‰ˆæœ¬æäº¤æ—¶ï¼Œå°±æ˜¯è§¦å‘è¿™ä¸€æ„å»ºæµç¨‹ã€‚

### 8.3 æµ‹è¯•Github actionçš„æ‰§è¡Œæ•ˆæœ
```bash
$ git add -A
$ git commit -m "version: 0.0.119"
$ git tag v0.0.119
$ git push origin master
$ git push --tags
```

<Img src='/images/WX20230110-153018.png' align='center' />

## 9 æœ¬æ¬¡ä¸»è¦çš„ä»£ç å˜åŠ¨

<details>
    <summary>.github/workflows/deployment_ios.yml</summary>

```yaml title=".github/workflows/deployment_ios.yml"
name: Appstore Deployment


on:
  push:
    tags:
      - v*

jobs:
  deploy_ios:
    name: Deploy build to TestFlight
    runs-on: macOS-latest
    steps:
      - name: Checkout code from ref
        uses: actions/checkout@v2
        with:
          ref: ${{ github.ref }}
      - name: Configure env
        run: |
          envFile="fastlane/.env";
          touch $envFile;
          cat >> $envFile  <<EOL
          GIT_AUTHORIZATION="${{ secrets.GIT_AUTHORIZATION }}"
          EOL
          cat >> $envFile  <<EOL
          APP_STORE_CONNECT_API_KEY_CONTENT="${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}"
          EOL
          cat >> $envFile  <<EOL
          APP_STORE_CONNECT_API_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}"
          EOL
          cat >> $envFile  <<EOL
          APP_STORE_CONNECT_API_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}"
          EOL
          cat >> $envFile  <<EOL
          APP_IDENTIFIER="${{ secrets.APP_IDENTIFIER }}"
          EOL
          cat >> $envFile  <<EOL
          MATCH_PASSWORD="${{ secrets.MATCH_PASSWORD }}"
          EOL
          cat >> $envFile  <<EOL
          TEMP_KEYCHAIN_USER="${{ secrets.TEMP_KEYCHAIN_USER }}"
          EOL
          cat >> $envFile  <<EOL
          FASTLANE_APPLE_ID="${{ secrets.FASTLANE_APPLE_ID }}"
          EOL
          cat >> $envFile  <<EOL
          ITC_TEAM_ID="${{ secrets.ITC_TEAM_ID }}"
          EOL
          cat >> $envFile  <<EOL
          DEVELOPER_PORTAL_TEAM_ID="${{ secrets.DEVELOPER_PORTAL_TEAM_ID }}"
          EOL
          cat >> $envFile  <<EOL
          GIT_AUTHORIZATION="${{ secrets.GIT_AUTHORIZATION }}"
          EOL
          cat $envFile
      - name: Sync Certificates.
        uses: maierj/fastlane-action@v1.4.0
        with:
          lane: syncCertificates
      - name: Deploy iOS Beta to TestFlight via Fastlane
        uses: maierj/fastlane-action@v1.4.0
        with:
          lane: beta
```
</details>

<details>
    <summary>fastlane/.env.example</summary>

```bash title="fastlane/.env.example"
APP_STORE_CONNECT_API_KEY_CONTENT="-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----"
# Identifies the issuer who created the authentication token. https://appstoreconnect.apple.com/access/api
APP_STORE_CONNECT_API_ISSUER_ID="<APP_STORE_CONNECT_API_ISSUER_ID>"
# The key of app store connect api. https://appstoreconnect.apple.com/access/api
APP_STORE_CONNECT_API_KEY_ID="<APP_STORE_CONNECT_API_KEY_ID>"

# APP IDENTIFIER, https://developer.apple.com/account/resources/identifiers/list
APP_IDENTIFIER="<APP_IDENTIFIER>"

# Fastlane match password
MATCH_PASSWORD="<MATCH_PASSWORD>"

# The name from keychain.
TEMP_KEYCHAIN_USER="<TEMP_KEYCHAIN_USER>"

# The IOS APP IDï¼Œ
FASTLANE_APPLE_ID="<FASTLANE_APPLE_ID>"

#App Store Connect Team ID, Used for itc_team_id in Appfile.
ITC_TEAM_ID="<ITC_TEAM_ID>"

#Developer Portal Team ID, Used for team_id in Appfile.
DEVELOPER_PORTAL_TEAM_ID="<DEVELOPER_PORTAL_TEAM_ID>"

# Github token to access repository for certificates.
GIT_AUTHORIZATION="<GIT_AUTHORIZATION>"

```
</details>

<details>
    <summary>fastlane/Appfile</summary>

```git title="fastlane/Appfile"

diff --git a/fastlane/Appfile b/fastlane/Appfile
index 203b64e..f454e10 100644
--- a/fastlane/Appfile
+++ b/fastlane/Appfile
@@ -1,8 +1,8 @@
-app_identifier("com.wuchuheng") # The bundle identifier of your app
-apple_id("root@wuchuheng.com") # Your Apple Developer Portal username
+app_identifier(ENV["APP_IDENTIFIER"]) # The bundle identifier of your app
+apple_id(ENV["FASTLANE_APPLE_ID"]) # Your Apple Developer Portal username

-itc_team_id("125598569") # App Store Connect Team ID
-team_id("5D6L6979M7") # Developer Portal Team ID
+itc_team_id(ENV["ITC_TEAM_ID"]) # App Store Connect Team ID
+team_id(ENV["DEVELOPER_PORTAL_TEAM_ID"]) # Developer Portal Team ID



```
    
</details>

<details>
    <summary>fastlane/Matchfile</summary>

```git title="fastlane/Matchfile"

diff --git a/fastlane/Matchfile b/fastlane/Matchfile
index 05986fc..c8ccc09 100644
--- a/fastlane/Matchfile
+++ b/fastlane/Matchfile
@@ -1,11 +1,12 @@
-git_url("git@github.com:wuchuheng/certificates.git")
+git_url("https://github.com/wuchuheng/certificates.git")

storage_mode("git")

type("development") # The default type, can be: appstore, adhoc, enterprise or development

-app_identifier(["com.wuchuheng"])
-username("root@wuchuheng.com") # Your Apple Developer Portal username
+# app_identifier(["tools.fastlane.app", "tools.fastlane.app2"])
+# username("user@fastlane.tools") # Your Apple Developer Portal username

# For all available options run `fastlane match --help`
# Remove the # in the beginning of the line to enable the other options
    
    

```
    
</details>

<details>
    <summary>fastlane/Fastfile</summary>

```rb title="fastlane/Fastfile"
default_platform(:ios)

api_key = app_store_connect_api_key(
    key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
    issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
    key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
)

platform :ios do
    desc "Download certificates from the git"
    lane :syncCertificates do
        match(
            api_key: api_key,
            type: "appstore",
            git_basic_authorization: Base64.strict_encode64(ENV["GIT_AUTHORIZATION"]),
            keychain_password: ENV["MATCH_PASSWORD"]
         )
        match(
           api_key: api_key,
           type: "development",
           git_basic_authorization: Base64.strict_encode64(ENV["GIT_AUTHORIZATION"]),
           keychain_password: ENV["MATCH_PASSWORD"]
       )
    end
  desc "Push a new beta build to TestFlight"
  lane :beta do
   if ENV['CI']
        create_keychain(
            name: ENV["TEMP_KEYCHAIN_USER"],
            password: ENV["MATCH_PASSWORD"],
            default_keychain: true,
            unlock: true,
            timeout: 3600,
            lock_when_sleeps: false
        )

        match(
            keychain_name: ENV["TEMP_KEYCHAIN_USER"],
            api_key: api_key,
            type: "appstore",
            git_basic_authorization: Base64.strict_encode64(ENV["GIT_AUTHORIZATION"]),
            keychain_password: ENV["MATCH_PASSWORD"]
         )
    end
    increment_build_number({ build_number: latest_testflight_build_number + 1 })
    build_app( scheme: "wuchuheng", xcodebuild_formatter: "" )
    upload_to_testflight(skip_waiting_for_build_processing: true)
  end
end
    
```
</details>

## 10 æ€»ç»“

æœ¬æ–‡æœ¬ä¸»è¦è¯´äº†2ä¸ªæ­¥éª¤ï¼Œä¸€ä¸ªæ˜¯**fastlane**çš„æœ¬åœ°æµç¨‹ï¼Œ ä¸€ä¸ªæ˜¯åœ¨**github action**ä¸Šæ‰§è¡Œå·²ç»æœ¬åœ°æ‰§è¡ŒæˆåŠŸçš„**fastlane**æµç¨‹ã€‚ å…¶ä¸­æƒ³è¦ç›¸å¯¹æ¯”è¾ƒå¤æ‚çš„
**fastlane**çš„æœ¬åœ°æµç¨‹ï¼Œæƒ³è¦æ‰§è¡ŒæˆåŠŸéœ€è¦åšå¥½4ä¸ªæ–¹é¢çš„å·¥ä½œ:   
1. ç¯å¢ƒå˜é‡çš„é…ç½®(fastlane/.env)
2. é…ç½®å¥½ `fastlane/Appfile`
3. é…ç½®å¥½ `fastlane/Fastfile`
4. `fastlane/Matchfile`ã€‚
è€Œè¿™å…¶ä¸­æ¯ä¸€æ–¹é¢çš„å‡ºé”™éƒ½ä¼šå¯¼è‡´æœ¬åœ°çš„æµç¨‹å¤±è´¥ã€‚  
&emmsp; è€Œæœ¬æ–‡çš„å¦ä¸€å¤§æ­¥éª¤æ˜¯**Github action**å»æ‰§è¡Œ**fastlane**æµç¨‹ã€‚è€Œæƒ³è¦ç¡®ä¿æˆåŠŸéœ€è¦ç¡®ä¿2ä¸ªå°æ­¥éª¤å‡†ç¡®ï¼š ä¸€ä¸ªæ˜¯çº¿ä¸Šçš„`evn`é…ç½®ï¼Œä¸€ä¸ªæ˜¯æœ¬åœ°çš„`.github/workflows/deployment_ios.yml`çš„é…ç½®ã€‚
ä¸»è¦å®¹æ˜“å‡ºé”™çš„å°±æ˜¯è¿™2ä¸ªåœ°æ–¹ã€‚ å¦å¤–è¿˜æœ‰å¦ä¸€ä¸ªåœ¨æœ¬åœ°ä¸ä¼šå‡ºé”™ä½†åœ¨çº¿ä¸Šä¼šå‡ºé”™çš„åœ°æ–¹ï¼Œé‚£å°±æ˜¯åœ¨çº¿ä¸Šæ„å»ºæ—¶ï¼Œéœ€è¦åœ¨æµç¨‹ä¸­åŠ å…¥åˆ›å»º`keychain`çš„æµç¨‹ã€‚ ä»£ç å¦‚ä¸‹: 
```ruby {4-21} title="fastlane/Fastfile"

...
lane :beta do
   if ENV['CI']
        create_keychain(
            name: ENV["TEMP_KEYCHAIN_USER"],
            password: ENV["MATCH_PASSWORD"],
            default_keychain: true,
            unlock: true,
            timeout: 3600,
            lock_when_sleeps: false
        )

        match(
            keychain_name: ENV["TEMP_KEYCHAIN_USER"],
            api_key: api_key,
            type: "appstore",
            git_basic_authorization: Base64.strict_encode64(ENV["GIT_AUTHORIZATION"]),
            keychain_password: ENV["MATCH_PASSWORD"]
         )
    end
    increment_build_number({ build_number: latest_testflight_build_number + 1 })
    build_app( scheme: "wuchuheng", xcodebuild_formatter: "" )
    upload_to_testflight(skip_waiting_for_build_processing: true)
  end
...

```
è¿™æ®µä»£ç æ˜¯æœ¬åœ°æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œä½†åœ¨çº¿ä¸Šæ„å»ºæ—¶éœ€è¦ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸€æ®µä»£ç ï¼Œé‚£ä¹ˆä¸æ˜¯é€‰æ‹©æ„å»ºæµç¨‹ä¸€ç›´å¡ä½ã€‚ä»è€Œæ— æ³•æ‰§è¡Œæ„å»ºæˆåŠŸã€‚


## 11 æºä»£ç 

[Source code](https://github.com/zhrr394RRRR4/com.wuchuheng.ios.helloWorld)

## 12 å‚è€ƒèµ„æ–™
* [Automate your workflow with the App Store Connect API](https://developer.apple.com/app-store-connect/api/)

